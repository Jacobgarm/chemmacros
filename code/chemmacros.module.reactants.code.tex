\ChemModule{reactants}{2020/11/29 typeset reactants and data}

\RequirePackage {chemnum}

\cs_generate_variant:Nn \chemnum_cmpd:nnnn {nnne}
\cs_generate_variant:Nn \chemnum_init:nn {ne}

% --------------------------------------------------------------------------
\bool_new:N \l__chemmacros_reactant_switch_bool
\bool_new:N \l__chemmacros_reactant_initiate_bool
\bool_new:N \l__chemmacros_reactant_noequivalents_bool

\bool_new:N \l__chemmacros_reactant_nmo_bool
\bool_new:N \l__chemmacros_reactant_mno_bool
\bool_new:N \l__chemmacros_reactant_mon_bool

\bool_new:N \l__chemmacros_reactant_snm_bool
\bool_new:N \l__chemmacros_reactant_smn_bool

\bool_new:N \l__chemmacros_reactant_mainchoicedefault_bool
\bool_new:N \l__chemmacros_reactant_mainchoiceamount_bool
\bool_new:N \l__chemmacros_reactant_mainchoiceequiv_bool

\bool_new:N \l__chemmacros_reactant_acronym_support_bool
\str_new:N  \l__chemmacros_reactant_acronym_support_str

\str_new:N \l__chemmacros_reactant_name_str

\tl_new:N \l__chemmacros_mass_unit_tl
\tl_new:N \l__chemmacros_volume_unit_tl
\tl_new:N \l__chemmacros_amount_unit_tl
\tl_new:N \l__chemmacros_concentration_unit_tl
\tl_new:N \l__chemmacros_equiv_unit_tl
\tl_new:N \l__chemmacros_fraction_unit_tl
\tl_new:N \l__chemmacros_purity_unit_tl
\tl_new:N \l__chemmacros_solution_name_tl

\chemmacros_define_keys:nn {reactants}
  {
    mass-unit .tl_set:N  = \l__chemmacros_mass_unit_tl ,
    mass-unit .default:n = \g ,
    %%
    volume-unit .tl_set:N  = \l__chemmacros_volume_unit_tl ,
    volume-unit .default:n = \mL ,
    %%
    amount-unit .tl_set:N  = \l__chemmacros_amount_unit_tl ,
    amount-unit .default:n = \mmol ,
    %%
    concentration-unit .tl_set:N  = \l__chemmacros_concentration_unit_tl ,
    concentration-unit .default:n = \Molar ,
    %%
    equiv-unit .tl_set:N  = \l__chemmacros_equiv_unit_tl ,
    equiv-unit .default:n = eq ,
    %%
    fraction-unit .tl_set:N  = \l__chemmacros_fraction_unit_tl ,
    fraction-unit .default:n = w/w \percent ,
    %%
    purity-unit .tl_set:N  = \l__chemmacros_purity_unit_tl ,
    purity-unit .default:n = \percent ,
    %%
    solution-name .tl_set:N  = \l__chemmacros_solution_name_tl ,
    solution-name .default:n = \chemmacros_translate:n {solution} ,
    %%
    switch .bool_set:N = \l__chemmacros_reactant_switch_bool ,
    switch .initial:n  = false ,
    %%
    initiate .bool_set:N = \l__chemmacros_reactant_initiate_bool ,
    initiate .initial:n  = false ,
    %%
    noequivalents .bool_set:N = \l__chemmacros_reactant_noequivalents_bool ,
    noequivalents .initial:n  = false ,
    %%
    reactant-output-style .choice: , 
    reactant-output-style / name-main-other .code:n =
      \bool_set_true:N \l__chemmacros_reactant_nmo_bool ,
    reactant-output-style / main-name-other .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mno_bool
        \bool_set_false:N \l__chemmacros_reactant_nmo_bool
      } ,
    reactant-output-style / main-other-name .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mon_bool
        \bool_set_false:N \l__chemmacros_reactant_nmo_bool
      } ,
    % reactant-output-style .default:n  = name-main-other ,
    reactant-output-style .initial:n  = name-main-other ,
    %%
    solvent-output-style .choice: ,
    solvent-output-style / main-name .code:n =
      \bool_set_true:N \l__chemmacros_reactant_smn_bool ,
    solvent-output-style / name-main .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_snm_bool
        \bool_set_false:N \l__chemmacros_reactant_smn_bool
      } ,
    % solvent-output-style .default:n  = main-name , 
    solvent-output-style .initial:n  = main-name ,
    %%
    main .choice: , 
    main / amount .code:n  = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mainchoiceamount_bool 
        \bool_set_false:N \l__chemmacros_reactant_mainchoicedefault_bool
      } ,
    main / equiv .code:n   = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mainchoiceequiv_bool
        \bool_set_false:N \l__chemmacros_reactant_mainchoicedefault_bool
      } ,
    main / default .code:n =
      \bool_set_true:N \l__chemmacros_reactant_mainchoicedefault_bool ,
    main .initial:n  = default ,
    %%
    acronym-support .choice: , 
    acronym-support / glossaries-extra .code:n =
      \bool_set_true:N \l__chemmacros_reactant_acronym_support_bool
      \str_set:Nn \l__chemmacros_reactant_acronym_support_str {glossaries} ,
    acronym-support / acro .code:n =
      \bool_set_true:N \l__chemmacros_reactant_acronym_support_bool
      \str_set:Nn \l__chemmacros_reactant_acronym_support_str {acro} ,
    acronym-support / none .code:n =
      \bool_set_false:N \l__chemmacros_reactant_acronym_support_bool
      \str_clear:N \l__chemmacros_reactant_acronym_support_str ,
    acronym-support .initial:n  = none
  }

\hook_gput_code:nnn {begindocument} {chemmacros}
  {
    \bool_if:NT \l__chemmacros_reactant_acronym_support_bool
      {
        \str_case:Vn \l__chemmacros_reactant_acronym_support_str
          {
            {glossaries} { \RequirePackage [acronyms] {glossaries-extra} }
            {acro} { \RequirePackage {acro} }
          }
      }
  }

\msg_new:nnn {chemmacros} {reactant-name}
  {
    The~ reactant~ `#1'~ has~ been~ defined~ without~ a~ name!~
    \msg_line_context:
  }
  
\msg_new:nnn {chemmacros} {undefined-key}
  {
    The~ reactant~ key~ `#1'~ has~ not~ been~ defined~ using~
    \token_to_str:N \DeclareChemReactant \c_space_tl \msg_line_context:
  }
  
\msg_new:nnn {chemmacros} {double-defined-key}
  {
    The~ reactant~ key~ `#1'~ has~ already~ been~ defined~ using~
    \token_to_str:N \DeclareChemReactant \c_space_tl \msg_line_context:
  }
  
\msg_new:nnn {chemmacros} {double-defined-key-acronym}
  {
    The~ reactant~ key~ `#1'~ has~ already~ been~ defined~ using~
    \token_to_str:N \DeclareAcronym \c_space_tl \msg_line_context:
  }
  
\msg_new:nnn {chemmacros} {incompatible-equivalents}
  {
    Incompatible~ options~ `noequivalents'~ and~ `main=equiv'~ detected.~
    `noequivalents'~ will~ be~ ignored~ \msg_line_context:
  }
  
\msg_new:nnn {chemmacros} {acronym-support-load}
  {
    \token_to_str:N \reactants,~ \token_to_str:N \reactantl,~
    \token_to_str:N \solvents,~ and~ \token_to_str:N \solventl'~ are~ only~
    available~ when~ using~ the~ `acro-support'~ option.
  }  
  
% --------------------------------------------------------------------------
% #1: key
% #2: properties
\NewDocumentCommand \DeclareChemReactant {mm}
  { \chemmacros_declare_reactant:nn {#1} {#2} }

% #1: key
% #2: properties
\cs_new_protected:Npn \chemmacros_declare_reactant:nn #1#2 
  {
    \cs_if_exist:cT 
      {l__chemmacros_reactant_#1_prop} 
      {\msg_error:nnn {chemmacros} {double-defined-key} {#1} }
    \prop_new:c {l__chemmacros_reactant_#1_prop}
    \__chemmacros_reactant_set_properties:nn {#1} {#2}
    % check if name given:
    \__chemmacros_reactant_if_property:nnF {#1} {name}
      { \msg_error:nnn {chemmacros} {reactant-name} {#1} }
    % check if number given; else use key: 
    \__chemmacros_reactant_if_property:nnF {#1} {number}
      { \__chemmacros_reactant_set_properties:nn {#1} { number = #1 } }
    \bool_if:NT \l__chemmacros_reactant_initiate_bool
      {
        \hook_gput_code:nnn {begindocument} {chemmacros}
          { \chemnum_init:ne {} { \__chemmacros_reactant_item:nn {#1} {number} } }
      }
    \bool_if:NT \l__chemmacros_reactant_acronym_support_bool
      {
        \str_case:Vn \l__chemmacros_reactant_acronym_support_str
          {
            {glossaries}
            {
              \__chemmacros_reactant_if_property:nnT {#1} {short}
                {
                  \exp_args:Nnxx
                  \newacronym
                    {#1}
                    { \__chemmacros_reactant_item:nn {#1} {short} }
                    { \chemmacros_iupac:e { \__chemmacros_reactant_item:nn {#1} {name} } }
                }
            }
            {acro}
            {
              \__chemmacros_reactant_if_property:nnT {#1} {short}
                {
                  \acro_if_defined:nT {#1}
                    { \msg_error:nnn {chemmacros} {double-defined-key-acronym} {#1} }
                  \exp_args:Nnx
                  \DeclareAcronym {#1} {
                    short = \__chemmacros_reactant_item:nn {#1} {short} ,
                    long  = \chemmacros_iupac:e { \__chemmacros_reactant_item:nn {#1} {name} }
                  }
                }
            }
          }
      }
  }

% #1: key
% #2: properties
\cs_new_protected:Npn \__chemmacros_reactant_set_properties:nn #1#2
  {
    \cs_set_protected:Npn \__chemmacros_reactant_property:nn ##1##2
      {
        \str_case:nnF {##1}
          { {name} { \__chemmacros_reactant_put:nnn {#1} {##1} {##2} } }
          { \__chemmacros_reactant_put:nnn {#1} {##1} {##2} }
      }
    \cs_set_protected:Npn \__chemmacros_reactant_property:n ##1
      { \__chemmacros_reactant_put:nnn {#1} {##1} {} }
    \keyval_parse:NNn
      \__chemmacros_reactant_property:n
      \__chemmacros_reactant_property:nn
      {#2}
  }

% #1: key
% #2: property
\prg_new_conditional:Npnn \__chemmacros_reactant_if_property:nn #1#2 {p,T,F,TF}
  {
    \prop_if_in:cnTF {l__chemmacros_reactant_#1_prop} {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: key
% #2: property
\cs_new:Npn \__chemmacros_reactant_item:nn #1#2
  { \prop_item:cn {l__chemmacros_reactant_#1_prop} {#2} }

% #1: key
% #2: property
% #3: value
\cs_new_protected:Npn \__chemmacros_reactant_put:nnn #1#2#3
  { \prop_put:cnn {l__chemmacros_reactant_#1_prop} {#2} {#3} }
  
% --------------------------------------------------------------------------
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options
\NewDocumentCommand \reactant {st+O{}mO{}}
  { 
    \str_set:Nn \l__chemmacros_reactant_name_str {regular}
    \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
  }
  
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options
\NewDocumentCommand \reactants {st+O{}mO{}}
  {
    \bool_if:NTF \l__chemmacros_reactant_acronym_support_bool
      {
        \str_set:Nn \l__chemmacros_reactant_name_str {short}
        \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
      }
      { \msg_error:nnn {chemmacros} {acronym-support-load} }
  }
  
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options
\NewDocumentCommand \reactantl {st+O{}mO{}}
  {
    \bool_if:NTF \l__chemmacros_reactant_acronym_support_bool
      {
        \str_set:Nn \l__chemmacros_reactant_name_str {long}
        \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
      }
      { \msg_error:nnn {chemmacros} {acronym-support-load} }
  }

% #1: boolean > no name
% #2: options
% #3: properties
% #4: key
% #5: boolean: if true, allow no properties and use cmpd+ 
\cs_new_protected:Npn \chemmacros_reactant:nnnnn #1#2#3#4#5
  {
     \group_begin:
      \bool_if:NT \l__chemmacros_reactant_nmo_bool
        {

          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
          \space
          \chemmacros_reactant_check_all:nn {#4} {(}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_main:nn
            {#4}
            { \chemmacros_reactant_check_other:nn {#4} {,~} }
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_all:nn {#4} {)} 
        }
      \bool_if:NT \l__chemmacros_reactant_mno_bool
        {
          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_main:nn {#4} {~}
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
          \chemmacros_reactant_check_other:nn {#4} {~(}
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_other:nn {#4} {)}
        }
      \bool_if:NT \l__chemmacros_reactant_mon_bool
        {
          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
           \chemmacros_reactant_check_main:nn {#4} {~} 
          \chemmacros_reactant_check_other:nn {#4} {(}
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_other:nn {#4} {)~}
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
        }
      \group_end:
  }
   
% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_main:nn #1#2
  {
    \bool_if:NT \l__chemmacros_reactant_mainchoicedefault_bool
      {
        \bool_lazy_or:nnT
          { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
        {#2}
    }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
      {
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
          }
          {#2}
      }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
      {
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
          }
          {#2}
      }
  }

% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_other:nn #1#2
  {
    \bool_if:NT \l__chemmacros_reactant_mainchoicedefault_bool
      {
        \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
          {
            \bool_lazy_any:nT
              {
                { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
                { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
              }
              {#2}
          }
          {
            \bool_lazy_any:nT
              {
                { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
                { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
              }
              {#2}
          }
      }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
      {
        \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
          {
            \bool_lazy_any:nT
              {
                { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
                { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
              }
              {#2}
          }
          {
            \bool_lazy_any:nT
              {
                { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
                {\__chemmacros_reactant_if_property_p:nn  {#1} {equiv} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
                { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
                { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
              }
              {#2}
          }
      }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
      {
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
          }
          {#2}
      }
  }

% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_all:nn #1#2
  {
    \bool_lazy_any:nT
      {
        { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
        { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
        { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
      }
      {#2}
  }
  
% #1: boolean > no name
% #2: options
% #3: key
% #4: boolean: if true, allow no properties and use cmpd+ 
\cs_new_protected:Npn \chemmacros_reactant_name:nnnn #1#2#3#4
  {
    \group_begin:
      \chemmacros_set_keys:nn {reactants} {#2} 
      \bool_lazy_or:nnT 
        { \bool_lazy_and_p:nn {#1} { !\l__chemmacros_reactant_switch_bool } } 
        { !#1 }
        {
          \str_case:Vn \l__chemmacros_reactant_name_str
            {
              {regular}
              {
                \chemmacros_iupac:e
                  { \__chemmacros_reactant_item:nn {#3} {name} }
              }
              {short}
              { 
                \str_case:Vn \l__chemmacros_reactant_acronym_support_str
                  {
                    {glossaries} { \glsxtrshort {#3} }
                    {acro} { \acs {#3} }
                  }
              }
              {long}
              { 
                \str_case:Vn \l__chemmacros_reactant_acronym_support_str
                  {
                    {glossaries} { \glsxtrlong {#3} }
                    {acro} { \acl {#3} }
                  }
              }
            }
        }
      \bool_if:nF {#1} { \nobreakspace }
      \bool_lazy_or:nnT
        { \bool_lazy_and_p:nn {#1} { \l__chemmacros_reactant_switch_bool } } 
        { !#1 }
        {
          \chemnum_cmpd:nnne
            { \c_false_bool }
            {#4}
            { }
            { \__chemmacros_reactant_item:nn {#3} {number} }       
          \bool_if:nF {#4}
            {
              \chemnum_compound_if_initiated:nF {#3}
                { \msg_warning:nnn {chemmacros} {undefined-key} {#3} }
            }
        }
    \group_end:
  }

% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \chemmacros_reactant_properties:nnn #1#2#3
  {
    \group_begin:
      \seq_clear:N \l__chemmacros_tmpa_seq
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
      \bool_lazy_any:nT
        {
          { \__chemmacros_reactant_if_property_p:nn {#3} {mass} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {volume} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {fraction} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {amount} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {equiv} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {purity} } 
          { \__chemmacros_reactant_if_property_p:nn {#3} {concentration} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {solvent} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {fraction-unit} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {amount-unit} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {equiv-unit} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {purity-unit} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {concentration-unit} }
        }
        {
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {fraction-unit}
            \l__chemmacros_fraction_unit_tl
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {amount-unit}
            \l__chemmacros_amount_unit_tl
          \bool_if:NF \l__chemmacros_reactant_noequivalents_bool
            {
              \__chemmacros_reactant_change_unit:nnN
                {#3}
                {equiv-unit}
                \l__chemmacros_equiv_unit_tl
            }
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {purity-unit}
            \l__chemmacros_purity_unit_tl
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {concentration-unit}
            \l__chemmacros_concentration_unit_tl
          \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
            {#3}
            {fraction}
            \l__chemmacros_fraction_unit_tl
          \bool_if:NF \l__chemmacros_reactant_mainchoiceamount_bool
            { 
              \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
                {#3}
                {amount}
                \l__chemmacros_amount_unit_tl
            }
          \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
            {
              \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
                { \msg_warning:nnn {chemmacros} {incompatible-equivalents} {#1} }
            }
            {
              \bool_if:NF \l__chemmacros_reactant_mainchoiceequiv_bool
                { 
                  \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
                    {#3}
                    {equiv}
                    \l__chemmacros_equiv_unit_tl
                }
            }
          \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
            {#3}
            {purity}
            \l__chemmacros_purity_unit_tl
          \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
            {#3}
            {concentration}
            \l__chemmacros_concentration_unit_tl
          \seq_use:Nn \l__chemmacros_tmpa_seq {,~}
          \__chemmacros_reactant_add_solvent:Nnn
            {#3}
            {solvent}
          \l__chemmacros_solution_name_tl
        }
    \group_end:
  }

% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \__chemmacros_reactant_mainproperty:nnn #1#2#3
  {
    \group_begin:
      \seq_clear:N \l__chemmacros_tmpa_seq
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
      \bool_lazy_or:nnT
        { \__chemmacros_reactant_if_property_p:nn {#3} {mass-unit} }
        { \__chemmacros_reactant_if_property_p:nn {#3} {volume-unit} }
        {
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {mass-unit}
            \l__chemmacros_mass_unit_tl
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {volume-unit}
            \l__chemmacros_volume_unit_tl
        }
      \bool_lazy_and:nnT
        { \l__chemmacros_reactant_mainchoiceamount_bool }
        { \__chemmacros_reactant_if_property_p:nn {#3} {amount-unit} }
        {
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {amount-unit}
            \l__chemmacros_amount_unit_tl
        }
      \bool_lazy_and:nnT
        { \l__chemmacros_reactant_mainchoiceequiv_bool }
        { \__chemmacros_reactant_if_property_p:nn {#3} {equiv-unit} }
        {
          \__chemmacros_reactant_change_unit:nnN
            {#3}
            {equiv-unit}
            \l__chemmacros_equiv_unit_tl
        }
      \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
        {#3}
        {mass}
        \l__chemmacros_mass_unit_tl
      \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
        {#3}
        {volume}
        \l__chemmacros_volume_unit_tl
      \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
        {
          \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
            {#3}
            {amount}
            \l__chemmacros_amount_unit_tl
        }
      \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
        {
          \__chemmacros_reactant_add_property:NnnV \l__chemmacros_tmpa_seq
            {#3}
            {equiv}
            \l__chemmacros_equiv_unit_tl
        }
      \seq_use:Nn \l__chemmacros_tmpa_seq {,~}
    \group_end:
  }  

% #1: seq variable
% #2: key
% #3: property
% #4: unit
\cs_new_protected:Npn \__chemmacros_reactant_add_property:Nnnn #1#2#3#4 
  {
    \__chemmacros_reactant_if_property:nnT {#2} {#3}
      {
        \seq_put_right:Nn #1 
          { \SI { \__chemmacros_reactant_item:nn {#2} {#3} } {#4} } 
      }
  }
\cs_generate_variant:Nn \__chemmacros_reactant_add_property:Nnnn {NnnV}  
  
% #1: key
% #2: property (name of solvent)
% #3: linking text
\cs_new_protected:Npn \__chemmacros_reactant_add_solvent:Nnn #1#2#3 
  {
    \__chemmacros_reactant_if_property:nnT {#1} {#2} 
      {
        \c_space_tl
        \l__chemmacros_solution_name_tl
        \c_space_tl
        \__chemmacros_reactant_item:nn {#1} {#2}  
      }
  }
\cs_generate_variant:Nn \__chemmacros_reactant_add_solvent:Nnn {NnV}

% #1: key
% #2: property 
% #3: new unit
\cs_new_protected:Npn \__chemmacros_reactant_change_unit:nnN #1#2#3
  {
    \__chemmacros_reactant_if_property:nnT {#1} {#2} 
      { \prop_get:cnN {l__chemmacros_reactant_#1_prop} {#2} #3 }
  }

% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solvent {O{}mO{}}
  {
    \group_begin:
      \str_set:Nn \l__chemmacros_reactant_name_str {regular}
      \chemmacros_solvent:nnn {#3} {#1} {#2}
    \group_end:
  }
  
% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solvents {O{}mO{}}
  {
    \group_begin:
      \bool_if_N:TF \l__chemmacros_reactant_acronym_support_bool
        {
          \str_set:Nn \l__chemmacros_reactant_name_str {short}
          \chemmacros_solvent:nnn {#3} {#1} {#2}
        }
        { \msg_error:nn {chemmacros} {acronym-support-load} }
    \group_end:
  }
 
% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solventl {O{}mO{}}
  {
    \group_begin:
      \bool_if:NTF \l__chemmacros_reactant_acronym_support_bool
        {
          \str_set:Nn \l__chemmacros_reactant_name_str {long}
          \chemmacros_solvent:nnn {#3} {#1} {#2}
        }
        { \msg_error:nn {chemmacros} {acronym-support-load} }
    \group_end:
  }

% #1: options
% #2: properties
% #3: key  
\cs_new_protected:Npn \chemmacros_solvent:nnn #1#2#3
  {
    \group_begin:
      \bool_if:NT \l__chemmacros_reactant_snm_bool
        {
          \__chemmacros_reactant_set_properties:nn {#3} {#2}
          \chemmacros_solvent_name:nn {#1} {#3}
          \chemmacros_reactant_check_main:nn {#3} {~(}
          \chemmacros_solvent_properties:nnn {#1} {#2} {#3}
          \chemmacros_reactant_check_main:nn {#3} {)}
        }
      \bool_if:NT \l__chemmacros_reactant_smn_bool
        {
          \__chemmacros_reactant_set_properties:nn {#3} {#2}
          \chemmacros_solvent_properties:nnn {#1} {#2} {#3}
          \chemmacros_reactant_check_main:nn {#3} {~}
          \chemmacros_solvent_name:nn {#1} {#3}
        }
    \group_end:
  }
  
% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \chemmacros_solvent_properties:nnn #1#2#3
  {
    \group_begin:
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
        \bool_lazy_or:nnT
          { \__chemmacros_reactant_if_property_p:nn {#3} {volume} }
          { \__chemmacros_reactant_if_property_p:nn {#3} {volume-unit} }
          {
            \__chemmacros_reactant_change_unit:NnV #3
              {volume-unit}
              \l__chemmacros_volume_unit_tl 
            \SI
              { \__chemmacros_reactant_item:nn {#3} {volume} }
              { \l__chemmacros_volume_unit_tl }
            
          }
      \group_end:
  }

% #1: options
% #2: key 
\cs_new_protected:Npn \chemmacros_solvent_name:nn #1#2
  {
    \group_begin:
      \chemmacros_set_keys:nn {reactants} {#1}
      \str_case:Vn \l__chemmacros_reactant_name_str
        {
          {regular}
          { \chemmacros_iupac:e { \__chemmacros_reactant_item:nn {#2} {name} } }
          {short}
          {
            \str_case:Vn \l__chemmacros_reactant_acronym_support_str
              {
                {glossaries} { \glsxtrshort {#2} }
                {acro} { \acs {#2} }
              }
           }
          {long}
          {
            \str_case:Vn \l__chemmacros_reactant_acronym_support_str
              {
                {glossaries} { \glsxtrlong {#2} }
                {acro} { \acl {#2} }
              }
          }
        }
    \group_end:
  }
  
\chemmacros_declare_translations:nn {solution}
  {
    fallback = solution~ in ,
    English  = solution~ in ,
    German   = Lösung~ in ,
  }

% --------------------------------------------------------------------------
\ChemModuleEnd
