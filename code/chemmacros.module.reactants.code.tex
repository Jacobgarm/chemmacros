\ChemModule{reactants}{2020/04/24 typeset reactants and data}

\chemmacros_load_modules:n {nomenclature,units}
\RequirePackage {chemnum}

\cs_generate_variant:Nn \chemnum_cmpd:nnnn {nnne}
\cs_generate_variant:Nn \chemnum_init:nn {ne}

% --------------------------------------------------------------------------
\bool_new:N \l__chemmacros_reactant_switch_bool
\bool_new:N \l__chemmacros_reactant_initiate_bool
\bool_new:N \l__chemmacros_reactant_noequivalents_bool

\bool_new:N \l__chemmacros_reactant_nmo_bool
\bool_new:N \l__chemmacros_reactant_mno_bool
\bool_new:N \l__chemmacros_reactant_mon_bool

\bool_new:N \l__chemmacros_reactant_snm_bool
\bool_new:N \l__chemmacros_reactant_smn_bool

\bool_new:N \l__chemmacros_reactant_mainchoicedefault_bool
\bool_new:N \l__chemmacros_reactant_mainchoiceamount_bool
\bool_new:N \l__chemmacros_reactant_mainchoiceequiv_bool

\bool_new:N \l__chemmacros_reactant_acronymchoicenone_bool
\bool_new:N \l__chemmacros_reactant_acronymchoiceglossaries_bool
\bool_new:N \l__chemmacros_reactant_acronymchoiceacro_bool

\bool_new:N \__chemmacros_reactant_nameuseshort_bool
\bool_new:N \__chemmacros_reactant_nameuselong_bool
\bool_new:N \__chemmacros_reactant_nameuseregular_bool


\chemmacros_define_keys:nn {reactants}
  {
    switch .bool_set:N = \l__chemmacros_reactant_switch_bool ,
    switch .initial:n  = false,
    
    initiate .bool_set:N = \l__chemmacros_reactant_initiate_bool ,
    initiate .initial:n  = false,
    
    noequivalents .bool_set:N = \l__chemmacros_reactant_noequivalents_bool ,
    noequivalents .initial:n  = false,
    
    reactant-output-style .choice:, 
    reactant-output-style / name-main-other .code:n = \bool_set_true:N \l__chemmacros_reactant_nmo_bool,
    reactant-output-style / main-name-other .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mno_bool
        \bool_set_false:N \l__chemmacros_reactant_nmo_bool
      },
    reactant-output-style / main-other-name .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mon_bool
        \bool_set_false:N \l__chemmacros_reactant_nmo_bool
      },
    reactant-output-style .default:n  = name-main-other, 
    reactant-output-style .initial:n  = name-main-other, 
    
    solvent-output-style .choice:, 
    solvent-output-style / main-name .code:n = \bool_set_true:N \l__chemmacros_reactant_smn_bool,
    solvent-output-style / name-main .code:n = 
      {
        \bool_set_true:N \l__chemmacros_reactant_snm_bool
        \bool_set_false:N \l__chemmacros_reactant_smn_bool
      },
    solvent-output-style .default:n  = main-name, 
    solvent-output-style .initial:n  = main-name,
    
    main .choice:, 
    main / amount .code:n  = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mainchoiceamount_bool 
        \bool_set_false:N \l__chemmacros_reactant_mainchoicedefault_bool
      },
    main / equiv .code:n   = 
      {
        \bool_set_true:N \l__chemmacros_reactant_mainchoiceequiv_bool
        \bool_set_false:N \l__chemmacros_reactant_mainchoicedefault_bool
      },
    main / default .code:n = \bool_set_true:N \l__chemmacros_reactant_mainchoicedefault_bool,
    main .default:n  = default,
    main .initial:n  = default, 
    
    acronym-support .choice:, 
    acronym-support / glossaries-extra .code:n  = 
      {
        \bool_set_true:N \l__chemmacros_reactant_acronymchoiceglossaries_bool 
        \bool_set_false:N \l__chemmacros_reactant_acronymchoicenone_bool
      },
    acronym-support / acro .code:n   = 
      {
        \bool_set_true:N \l__chemmacros_reactant_acronymchoiceacro_bool
        \bool_set_false:N \l__chemmacros_reactant_acronymchoicenone_bool
      },
    acronym-support / none .code:n = \bool_set_true:N \l__chemmacros_reactant_acronymchoicenone_bool,
    acronym-support .default:n  = none,
    acronym-support .initial:n  = none,    
  }
  
  
\bool_if:NT \l__chemmacros_reactant_acronymchoiceglossaries_bool{
\RequirePackage[acronyms]{glossaries-extra}
}

\bool_if:NT \l__chemmacros_reactant_acronymchoiceacro_bool{
\RequirePackage[acronyms]{acro}
}



\msg_new:nnn {chemmacros} {reactant-name}
  { The~ reactant~ `#1'~ has~ been~ defined~ without~ a~ name!~ \msg_line_context: }
  
\msg_new:nnn {chemmacros} {undefined-key}
  { The~ reactant~ key~ `#1'~ has~ not~ been~ defined~ using~ the~ DeclareChemReactant~ command!~ \msg_line_context: }
  
\msg_new:nnn {chemmacros} {double-defined-key}
  { The~ reactant~ key~ `#1'~ has~ already~ been~ defined~ using~ the~ DeclareChemReactant~ command!~ \msg_line_context: }
  
\msg_new:nnn {chemmacros} {double-defined-key-acronym}
  { The~ reactant~ key~ `#1'~ has~ already~ been~ defined~ using~ the~ DeclareAcronym~ command!~ \msg_line_context: }
  
\msg_new:nnn {chemmacros} {incompatible-equivalents}
  { Incompatible~ options~ noequivalents~ and~ main=equiv~ detected.~ noequivalents~ will~ be~ ignored!~ \msg_line_context: }
  
\msg_new:nnn {chemmacros} {acronym-support-glossaries-load}
  { Using~ the~ acro-support=glossaries-extra~ option~ requires~ to~ load~ the~ glossaries-extra~ package~ with~ the~ acronym~ option.}
  
\msg_new:nnn {chemmacros} {acronym-support-acro-load}
  { Using~ the~ acro-support=acro~ option~ requires~ to~ load~ the~ acro~ package.}
  
\msg_new:nnn {chemmacros} {acronym-support-load}
  { reactants~, reactantl,~ solvents~ and~ solventl~ are~ only~ available~ when~ using~ the~ acro-support=...~ option.}
  
  
% --------------------------------------------------------------------------
% #1: key
% #2: properties
\NewDocumentCommand \DeclareChemReactant {mm}
  { \chemmacros_declare_reactant:nn {#1} {#2} }

% #1: key
% #2: properties
\cs_new_protected:Npn \chemmacros_declare_reactant:nn #1#2 
  {
    \cs_if_exist:cT 
      {l__chemmacros_reactant_#1_prop} 
      {\msg_error:nnn {chemmacros} {double-defined-key} {#1} }
    \prop_new:c {l__chemmacros_reactant_#1_prop}
    \__chemmacros_reactant_set_properties:nn {#1} {#2}
    % check if name given:
    \__chemmacros_reactant_if_property:nnF {#1} {name}
      { \msg_error:nnn {chemmacros} {reactant-name} {#1} }
    % check if number given; else use key: 
    \__chemmacros_reactant_if_property:nnF {#1} {number}
      { \__chemmacros_reactant_set_properties:nn {#1} { number = #1 } }
    \bool_if:NT \l__chemmacros_reactant_initiate_bool
      {
        \AtBeginDocument
          { \chemnum_init:ne {} { \__chemmacros_reactant_item:nn {#1} {number} } }
      }
    \bool_if:NT \l__chemmacros_reactant_acronymchoiceglossaries_bool
      { 
        \chemmacros_if_package_loaded:nF {glossaries-extra} {\msg_error:nnn {chemmacros} {acronym-support-glossaries-load}{#1}} 
        \__chemmacros_reactant_if_property:nnT {#1} {short}
          {
          \newacronym{#1}{\__chemmacros_reactant_item:nn {#1} {short}}{\__chemmacros_reactant_item:nn {#1} {name}}
          }
      }
    \bool_if:NT \l__chemmacros_reactant_acronymchoiceacro_bool
      { 
        \chemmacros_if_package_loaded:nF {acro} {\msg_error:nnn {chemmacros} {acronym-support-acro-load}{#1}} 
        \__chemmacros_reactant_if_property:nnT {#1} {short}
          {
          \cs_if_exist:cT 
            {g__acro_#1_int} 
            {\msg_error:nnn {chemmacros} {double-defined-key-acronym} {#1} }
          \DeclareAcronym{#1}{short={\__chemmacros_reactant_item:nn {#1} {short}}, long={\__chemmacros_reactant_item:nn {#1} {name}}}
          }
      }
  }

% #1: key
% #2: properties
\cs_new_protected:Npn \__chemmacros_reactant_set_properties:nn #1#2
  {
    \cs_set_protected:Npn \__chemmacros_reactant_property:nn ##1##2
      {
        \str_case:nnF {##1}
          { {name} { \__chemmacros_reactant_put:nnn {#1} {##1} {##2} } }
          { \__chemmacros_reactant_put:nnn {#1} {##1} {##2} }
      }
    \cs_set_protected:Npn \__chemmacros_reactant_property:n ##1
      { \__chemmacros_reactant_put:nnn {#1} {##1} {} }
    \keyval_parse:NNn
      \__chemmacros_reactant_property:n
      \__chemmacros_reactant_property:nn
      {#2}
  }

% #1: key
% #2: property
\prg_new_conditional:Npnn \__chemmacros_reactant_if_property:nn #1#2 {p,T,F,TF}
  {
    \prop_if_in:cnTF {l__chemmacros_reactant_#1_prop} {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: key
% #2: property
\cs_new:Npn \__chemmacros_reactant_item:nn #1#2
  { \prop_item:cn {l__chemmacros_reactant_#1_prop} {#2} }

% #1: key
% #2: property
% #3: value
\cs_new_protected:Npn \__chemmacros_reactant_put:nnn #1#2#3
  { \prop_put:cnn {l__chemmacros_reactant_#1_prop} {#2} {#3} }
  
% --------------------------------------------------------------------------
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options
\NewDocumentCommand \reactant {st+O{}mO{}}
  { 
  \bool_set_true:N {\__chemmacros_reactant_nameuseregular_bool}
  \bool_set_false:N {\__chemmacros_reactant_nameuseshort_bool}
  \bool_set_false:N {\__chemmacros_reactant_nameuselong_bool}
  \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
  }
  
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options

\NewDocumentCommand \reactants {st+O{}mO{}}
{
  \bool_lazy_any:nTF
  {
    { \l__chemmacros_reactant_acronymchoiceglossaries_bool }
    { \l__chemmacros_reactant_acronymchoiceacro_bool }
  }
  {
    \bool_set_true:N {\__chemmacros_reactant_nameuseshort_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseregular_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuselong_bool} 
    \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
  }
  {
    \msg_error:nnn {chemmacros} {acronym-support-load} 
  }
}




  
% #1: boolean > no name
% #2: boolean: if true, allow no properties and use cmpd+ 
% #3: properties
% #4: key
% #5: options
\NewDocumentCommand \reactantl {st+O{}mO{}}
{
  \bool_lazy_any:nTF
  {
    { \l__chemmacros_reactant_acronymchoiceglossaries_bool }
    { \l__chemmacros_reactant_acronymchoiceacro_bool }
  }
  {
    \bool_set_true:N {\__chemmacros_reactant_nameuselong_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseregular_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseshort_bool} 
    \chemmacros_reactant:nnnnn {#1} {#5} {#3} {#4} {#2}
  }
  {
    \msg_error:nnn {chemmacros} {acronym-support-load} 
  }
}
  

% #1: boolean > no name
% #2: options
% #3: properties
% #4: key
% #5: boolean: if true, allow no properties and use cmpd+ 
\cs_new_protected:Npn \chemmacros_reactant:nnnnn #1#2#3#4#5
  {
     \group_begin:
      \bool_if:NT \l__chemmacros_reactant_nmo_bool
        {

          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
          \space
          \chemmacros_reactant_check_all:nn {#4} {(}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_main:nn {#4} {\chemmacros_reactant_check_other:nn {#4} {,\space} }
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_all:nn {#4} {)} 
        }
      \bool_if:NT \l__chemmacros_reactant_mno_bool
        {
          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_main:nn {#4} {\space} 
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
          \chemmacros_reactant_check_other:nn {#4} {\space(}
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_other:nn {#4} {)}
        }
      \bool_if:NT \l__chemmacros_reactant_mon_bool
        {
          \__chemmacros_reactant_set_properties:nn {#4} {#3}
          \__chemmacros_reactant_mainproperty:nnn {#2} {#3} {#4}
           \chemmacros_reactant_check_main:nn {#4} {\space} 
          \chemmacros_reactant_check_other:nn {#4} {(}
          \chemmacros_reactant_properties:nnn {#2} {#3} {#4}
          \chemmacros_reactant_check_other:nn {#4} {)\space}
          \chemmacros_reactant_name:nnnn {#1} {#2} {#4} {#5}
        }
      \group_end:
  }

   
% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_main:nn #1#2
  {
    \bool_if:NT \l__chemmacros_reactant_mainchoicedefault_bool
    {
      \bool_lazy_any:nT
        {
          { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
        }
        {#2}
    }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
    {
      \bool_lazy_any:nT
        {
          { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
        }
        {#2}
    }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
    {
      \bool_lazy_any:nT
        {
          { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
          { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
        }
        {#2}
    }
  }


% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_other:nn #1#2
  {
    \bool_if:NT \l__chemmacros_reactant_mainchoicedefault_bool
    {
      \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
      {
        \bool_lazy_any:nT
          {
               { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
               { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
        }
        {#2}
      }
      {
        \bool_lazy_any:nT
          {
               { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
               { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
               { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
        }
        {#2}
      }
    }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
    {
      \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
      {
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
        }
        {#2}
      }
      {
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
            {\__chemmacros_reactant_if_property_p:nn  {#1} {equiv} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
        }
        {#2}
      }
    }
    \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
    {
      \bool_lazy_any:nT
        {
            { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
        }
        {#2}
    }
  }
   
  
% #1: key
% #2: true code
\cs_new_protected:Npn \chemmacros_reactant_check_all:nn #1#2
  {
      \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#1} {mass} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {volume} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {fraction} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {amount} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {equiv} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#1} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#1} {solvent} }
          }
          {#2}
  }
  
  
% #1: boolean > no name
% #2: options
% #3: key
% #4: boolean: if true, allow no properties and use cmpd+ 
\cs_new_protected:Npn \chemmacros_reactant_name:nnnn #1#2#3#4
  {
    \group_begin:
      \chemmacros_set_keys:nn {reactants} {#2} 
      \bool_lazy_or:nnT 
        { \bool_lazy_and_p:nn {#1} { !\l__chemmacros_reactant_switch_bool } } 
        { !#1 } 
        { 
        \bool_if:nT { \__chemmacros_reactant_nameuseregular_bool } { \__chemmacros_reactant_item:nn {#3} {name} }
        \bool_if:nT 
          { \__chemmacros_reactant_nameuseshort_bool } 
          { 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceglossaries_bool } { \glsxtrshort{#3} } 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceacro_bool } { \acs{#3} } 
          }
        \bool_if:nT 
          { \__chemmacros_reactant_nameuselong_bool } 
          { 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceglossaries_bool } { \glsxtrlong{#3} } 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceacro_bool } { \acl{#3} } 
          }
      \bool_if:nF {#1} { \nobreakspace } 
      \bool_lazy_or:nnT 
        { \bool_lazy_and_p:nn {#1} { \l__chemmacros_reactant_switch_bool } } 
        { !#1 } 
        { 
          \chemnum_cmpd:nnne
            { \c_false_bool }
            { #4 }
            { }
            { \__chemmacros_reactant_item:nn {#3} {number} }
       
       \bool_if:nF
       {#4}
       {\chemnum_compound_if_initiated:nF {#3}
         {
           \msg_warning:nnn {chemmacros} {undefined-key}  {#3}
         }
       } 
       }
    \group_end:
  }
}

% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \chemmacros_reactant_properties:nnn #1#2#3
  {
    \group_begin:
      \seq_clear:N \l__chemmacros_tmpa_seq
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#3} {mass} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {volume} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {fraction} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {amount} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {equiv} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {purity} } 
            { \__chemmacros_reactant_if_property_p:nn {#3} {concentration} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {solvent} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {fraction-unit} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {amount-unit} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {equiv-unit} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {purity-unit} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {concentration-unit} }
          }
          {
            \__chemmacros_reactant_change_unit:Nnn {#3} {fraction-unit} \defaultfractionunit
            \__chemmacros_reactant_change_unit:Nnn {#3} {amount-unit} \defaultamountunit
            \bool_if:NF \l__chemmacros_reactant_noequivalents_bool
            {
              \__chemmacros_reactant_change_unit:Nnn {#3} {equiv-unit} \defaultequivunit
            }
            \__chemmacros_reactant_change_unit:Nnn {#3} {purity-unit} \defaultpurityunit
            \__chemmacros_reactant_change_unit:Nnn {#3} {concentration-unit} \defaultconcentrationunit
            \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {fraction} {\defaultfractionunit}
            \bool_if:NF \l__chemmacros_reactant_mainchoiceamount_bool
            { 
              \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {amount} {\defaultamountunit}
            }
            \bool_if:NTF \l__chemmacros_reactant_noequivalents_bool
              {
                \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
                  {
                    \msg_warning:nnn {chemmacros} {incompatible-equivalents} {#1}
                  }
              }
              {
                \bool_if:NF \l__chemmacros_reactant_mainchoiceequiv_bool
                  { 
                    \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {equiv} {\defaultequivunit}
                  }
              }
          \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {purity} {\defaultpurityunit}
          \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {concentration} {\defaultconcentrationunit}
          \seq_use:Nn \l__chemmacros_tmpa_seq {,~} \__chemmacros_reactant_add_solvent:Nnn{#3}{solvent}{\solutionname}
        }
    \group_end:
  }
  

% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \__chemmacros_reactant_mainproperty:nnn #1#2#3
  {
    \group_begin:
    \seq_clear:N \l__chemmacros_tmpa_seq
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#3} {mass-unit} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {volume-unit} }
          }
          {
            \__chemmacros_reactant_change_unit:Nnn {#3} {mass-unit} \defaultmassunit
            \__chemmacros_reactant_change_unit:Nnn {#3} {volume-unit} \defaultvolumeunit
          }
        \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
          {
          \bool_lazy_any:nT
            {
              { \__chemmacros_reactant_if_property_p:nn {#3} {amount-unit} }
            }
          }
          {
            \__chemmacros_reactant_change_unit:Nnn {#3} {amount-unit} \defaultamountunit
          }
        \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
        {
          \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#3} {equiv-unit} }
          }
          }
          {
            \__chemmacros_reactant_change_unit:Nnn {#3} {equiv-unit} \defaultequivunit
        }
        \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {mass} {\defaultmassunit}
        \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {volume} {\defaultvolumeunit}
        \bool_if:NT \l__chemmacros_reactant_mainchoiceamount_bool
           {
             \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {amount} {\defaultamountunit}
           }
        \bool_if:NT \l__chemmacros_reactant_mainchoiceequiv_bool
           {
             \__chemmacros_reactant_add_property:Nnnn \l__chemmacros_tmpa_seq {#3} {equiv} {\defaultequivunit}
           }
        \seq_use:Nn \l__chemmacros_tmpa_seq {,~}
    \group_end:
  }  
    

% #1: seq variable
% #2: key
% #3: property
% #4: unit
\cs_new_protected:Npn \__chemmacros_reactant_add_property:Nnnn #1#2#3#4 
  {
    \__chemmacros_reactant_if_property:nnT {#2} {#3} 
      {
        \seq_put_right:Nn #1 
          { \SI { \__chemmacros_reactant_item:nn {#2} {#3} } {#4} } 
      }
  }
  
  
% #1: key
% #2: property (name of solvent)
% #3: linking text
\cs_new_protected:Npn \__chemmacros_reactant_add_solvent:Nnn #1#2#3 
  {
    \__chemmacros_reactant_if_property:nnT {#1} {#2} 
      {
       \space\solutionname\space\__chemmacros_reactant_item:nn {#1} {#2}  
      }
  }


% #1: key
% #2: property 
% #3: new unit
\cs_new_protected:Npn \__chemmacros_reactant_change_unit:Nnn #1#2#3
  {
    \__chemmacros_reactant_if_property:nnT {#1} {#2} 
      {
        \prop_get:cnN {l__chemmacros_reactant_#1_prop} {#2} #3
      }
  }
  
  

% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solvent {O{}mO{}}
  {
  \bool_set_true:N {\__chemmacros_reactant_nameuseregular_bool}
  \bool_set_false:N {\__chemmacros_reactant_nameuseshort_bool}
  \bool_set_false:N {\__chemmacros_reactant_nameuselong_bool}
  \chemmacros_solvent:nnn {#3} {#1} {#2}
  }
  
% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solvents {O{}mO{}}
{
  \bool_lazy_any:nTF
  {
    { \l__chemmacros_reactant_acronymchoiceglossaries_bool }
    { \l__chemmacros_reactant_acronymchoiceacro_bool }
  }
  {
    \bool_set_true:N {\__chemmacros_reactant_nameuseshort_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseregular_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuselong_bool} 
    \chemmacros_solvent:nnn {#3} {#1} {#2}
  }
  {
    \msg_error:nnn {chemmacros} {acronym-support-load} 
  }
}

 
% #1: properties
% #2: key
% #3: options
\NewDocumentCommand \solventl {O{}mO{}}
{
  \bool_lazy_any:nTF
  {
    { \l__chemmacros_reactant_acronymchoiceglossaries_bool }
    { \l__chemmacros_reactant_acronymchoiceacro_bool }
  }
  {
    \bool_set_true:N {\__chemmacros_reactant_nameuselong_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseregular_bool}
    \bool_set_false:N {\__chemmacros_reactant_nameuseshort_bool} 
    \chemmacros_solvent:nnn {#3} {#1} {#2}
  }
  {
    \msg_error:nnn {chemmacros} {acronym-support-load} 
  }
}
  


% #1: options
% #2: properties
% #3: key  
\cs_new_protected:Npn \chemmacros_solvent:nnn #1#2#3
  {
     \group_begin:
      \bool_if:NT \l__chemmacros_reactant_snm_bool
        {
          \__chemmacros_reactant_set_properties:nn {#3} {#2}
          \chemmacros_solvent_name:nn {#1} {#3}
          \chemmacros_reactant_check_main:nn {#3} {\space(}
          \chemmacros_solvent_properties:nnn {#1} {#2} {#3}
          \chemmacros_reactant_check_main:nn {#3} {)}
        }
      \bool_if:NT \l__chemmacros_reactant_smn_bool
        {
          \__chemmacros_reactant_set_properties:nn {#3} {#2}
          \chemmacros_solvent_properties:nnn {#1} {#2} {#3}
          \chemmacros_reactant_check_main:nn {#3} {\space}
          \chemmacros_solvent_name:nn {#1} {#3}
        }
  \group_end:
  }
  
% #1: options
% #2: properties
% #3: key
\cs_new_protected:Npn \chemmacros_solvent_properties:nnn #1#2#3
  {
    \group_begin:
      \__chemmacros_reactant_set_properties:nn {#3} {#2}
      \chemmacros_set_keys:nn {reactants} {#1}
        \bool_lazy_any:nT
          {
            { \__chemmacros_reactant_if_property_p:nn {#3} {volume} }
            { \__chemmacros_reactant_if_property_p:nn {#3} {volume-unit} }
          }
          {
            \__chemmacros_reactant_change_unit:Nnn {#3} {volume-unit} \defaultvolumeunit 
            \SI{\__chemmacros_reactant_item:nn {#3} {volume}}{\defaultvolumeunit}
            
          }
    \group_end:
  }
  

% #1: options
% #2: key 
\cs_new_protected:Npn \chemmacros_solvent_name:nn #1#2
  {
    \group_begin:
      \chemmacros_set_keys:nn {reactants} {#1} 
      \bool_if:nT { \__chemmacros_reactant_nameuseregular_bool } { \__chemmacros_reactant_item:nn {#2} {name} }
      \bool_if:nT { \__chemmacros_reactant_nameuseshort_bool } 
        { \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceglossaries_bool } { \glsxtrshort{#2} } 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceacro_bool } { \acs{#2} }  
         }
      \bool_if:nT { \__chemmacros_reactant_nameuselong_bool } 
        { \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceglossaries_bool } { \glsxtrshort{#2} } 
            \bool_if:nT 
            { \l__chemmacros_reactant_acronymchoiceacro_bool } { \acs{#2} } 
        }
    \group_end:
  }
  
  
\tl_set:Nn \defaultmassunit { \g }
\tl_set:Nn \defaultvolumeunit { \mL }
\tl_set:Nn \defaultamountunit { \mmol }
\tl_set:Nn \defaultconcentrationunit { \Molar }
\tl_set:Nn \defaultequivunit { eq }
\tl_set:Nn \defaultfractionunit { w/w \percent }
\tl_set:Nn \defaultpurityunit { \percent }
\tl_set:Nn \solutionname { \chemmacros_translate:n {solution} }

\chemmacros_define_keys:nn {reactants}
  {
    default-mass-unit .tl_set:N = \defaultmassunit ,
    default-volume-unit .tl_set:N = \defaultvolumeunit ,
    default-amount-unit .tl_set:N = \defaultamountunit ,
    default-concentration-unit .tl_set:N = \defaultconcentrationunit ,
    default-equiv-unit .tl_set:N = \defaultequivunit ,
    default-fraction-unit .tl_set:N = \defaultfractionunit ,
    default-purity-unit .tl_set:N = \defaultpurityunit ,
    solution-name .tl_set:N = \solutionname ,
  }
  
\chemmacros_declare_translations:nn {solution}
  {
    fallback = solution~ in ,
    English  = solution~ in ,
    German   = Lösung~ in ,
  }
  
   
% --------------------------------------------------------------------------
\ChemModuleEnd
